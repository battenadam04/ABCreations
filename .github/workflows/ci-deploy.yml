name: CI and Deploy with Lighthouse

on:
  push:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      # -----------------------
      # CHECKOUT CURRENT COMMIT
      # -----------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # IMPORTANT â€” allows checking out previous commit

      - name: Get previous commit
        id: prev
        run: echo "sha=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT

      # -----------------------
      # SETUP NODE
      # -----------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # -----------------------
      # INSTALL & BUILD CURRENT COMMIT
      # -----------------------
      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npm run typecheck --if-present

      - name: Lint (Next.js lint)
        run: npm run lint --if-present

      - name: Run tests
        run: npm test --if-present

      - name: Build app (current commit)
        run: npm run build

      - name: Start server (current commit)
        run: |
          nohup npm run start &
          sleep 7

      - name: Run Lighthouse (current commit)
        run: npx lhci collect --outputDir=./lhci-current

      # Save current report
      - name: Upload current report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-current
          path: lhci-current

      # -----------------------
      # CHECKOUT PREVIOUS COMMIT
      # -----------------------
      - name: Checkout previous commit
        run: |
          git checkout ${{ steps.prev.outputs.sha }}
          npm ci
          npm run build

      - name: Start server (previous commit)
        run: |
          nohup npm run start &
          sleep 7

      - name: Run Lighthouse on previous commit
        run: npx lhci collect --outputDir=./lhci-previous

      # Save previous report
      - name: Upload previous report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-previous
          path: lhci-previous

      # -----------------------
      # ASSERT SCORES BETWEEN CURRENT & PREVIOUS
      # -----------------------
      - name: Assert Lighthouse Regression
        run: |
          npx lhci assert \
            --budgetsFile=./lighthouse-budgets.json \
            --collect.url=http://localhost:3000 \
            --compare.baselineFolder=./lhci-previous \
            --compare.compareFolder=./lhci-current

      # -----------------------
      # DEPLOY TO VERCEL
      # -----------------------
      - name: Trigger Vercel Deployment
        if: success()
        run: |
          echo "Triggering Vercel Deploy Hook..."
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
